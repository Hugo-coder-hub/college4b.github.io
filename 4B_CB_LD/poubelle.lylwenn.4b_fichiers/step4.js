define('app/core/poll/genericpoller',["require","exports"],function(e,i){Object.defineProperty(i,"__esModule",{value:!0}),i.genericpolling=void 0;i=i.genericpolling={};i.PollingModule=class{get sandbox(){if(this._sandbox)return this._sandbox;throw new Error("Sandbox is not set")}set sandbox(e){this._sandbox=e}constructor(e){this.sandbox=e}activate(e){this.pollingTimer.start()}deactivate(){this.pollingTimer.stop()}},i.PollingEngine=class{constructor(e){this.isPollingRequestPending=!1,this.sandbox=e}performPoll(){return this.sandbox.logger.i("genericpollser performPoll"),!this.isPolling()&&!(!PearltreesEnvParams.userId||PearltreesEnvParams.userId<=0||(this.isPollingRequestPending=!0,this.pollInternal(),0))}pollInternal(){}onPollingSuccess(e){}onPollingFailed(){}isPolling(){return this.isPollingRequestPending}},i.PollingScheduler=class{constructor(e,i){this.sandbox=e,this.engine=i,this.intervalId=0,this.sandbox.getEventBus().subscribeTo(14,0,e=>{this.setFocus(e.focus)},this),this.hasFocus=!0,this.lastPollingTimeTimeInMs=0,e.getEventBus().publish(14,1,e=>{this.hasFocus=e})}setFocus(e){this.sandbox.logger.i("genericpollser setFocus"+e),e!=this.hasFocus&&(this.hasFocus=e)&&this.onTimeout()}clearTimer(){0<this.intervalId&&(clearInterval(this.intervalId),this.intervalId=0)}start(){this.clearTimer(),this.onTimeout()}performPoll(){this.sandbox.logger.i("genericpollser performPoll "+this.engine.isPolling()),this.engine.isPolling()||(this.lastPollingTimeTimeInMs=(new Date).getTime(),this.engine.performPoll())}hasBeenWaitingLongEnough(){return-1===this.getPollingTimeOut()||(new Date).getTime()>this.lastPollingTimeTimeInMs+this.getPollingTimeOut()-1}onTimeout(){this.sandbox.logger.i("genericpollser onTimeout "+this.hasFocus+" : "+this.hasBeenWaitingLongEnough()),this.hasFocus&&this.hasBeenWaitingLongEnough()&&this.performPoll()}stop(){this.clearTimer()}getPollingTimeOut(){return-1}schedulePolling(e){0<e&&(this.stop(),setTimeout(()=>{this.start()},e))}}});
define('app/gen/service/mynetwork',["require","exports","app/core/stats/statsclient","jquery"],function(e,t,y){function w(e,t,r,n,o,s,i,a,u,l,c,m){var y=(new Date).getTime(),t={userId:t,firstNotifId:r,lastNotifId:n,lastLoadedIndex:o,date:s,isNovelty:i,filterVal:a,userIds:JSON.stringify(u),targetTreeId:l};e.request({url:"mynetworkapi/copyAndDeleteNetworkItems",data:t,onSuccess:function(e,t){c(e.copyCount,e.deleteCount)},onError:m,requestType:"POST",startTime:y})}function l(e,t,r,n,o,s,i,a,u){var l=(new Date).getTime(),t={userId:t,firstNotifId:r,date:n,isNovelty:o,filterVal:s,userIds:JSON.stringify(i)};e.request({url:"mynetworkapi/deleteAllNetworkItems",data:t,onSuccess:function(e,t){a(e.found)},onError:u,requestType:"POST",startTime:l})}function i(e,t,r,n,o,s){var i=(new Date).getTime();e.request({url:"mynetworkapi/deleteMyNetworkItem",data:{userId:t,itemId:r,isNovelty:n},onSuccess:function(e,t){o(e.found)},onError:s,requestType:"POST",startTime:i})}function c(n,e,t,r,o,s,i,a,u,l){var c=(new Date).getTime();n.request({url:"mynetworkapi/getMyNetworkFilterList",data:{userId:e,baseDate:t,numberOfItemsInCurrentCollection:r,numberOfItemsToLoad:o,lastSeenAck:s,filterVal:i,lastNotifId:a},onSuccess:function(e,t){var r=(new Date).getTime(),t=(y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkFilterList:serializeAndCall"}),(new Date).getTime());y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkFilterList:deserialize"}),u(e.hasMore,e.newActivitiesCount,e.seenAckDate,e.list)},onError:l,requestType:"GET",startTime:c})}function m(n,e,t,r,o,s,i,a,u,l,c){var m=(new Date).getTime(),e={userId:e,baseDate:t,numberOfItemsInCurrentCollection:r,numberOfItemsToLoad:o,lastSeenAck:s,filterVal:i,userIds:JSON.stringify(a),lastNotifId:u};n.request({url:"mynetworkapi/getMyNetworkFilterList2",data:e,onSuccess:function(e,t){var r=(new Date).getTime(),t=(y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkFilterList2:serializeAndCall"}),(new Date).getTime());y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkFilterList2:deserialize"}),l(e.hasMore,e.newActivitiesCount,e.seenAckDate,e.list)},onError:c,requestType:"GET",startTime:m})}function s(e,t,r,n,o){var s=(new Date).getTime();e.request({url:"mynetworkapi/getMyNetworkItem",data:{userId:t,itemId:r},onSuccess:function(e,t){n(e.found,e.item)},onError:o,requestType:"GET",startTime:s})}function u(n,e,t,r,o,s,i,a){var u=(new Date).getTime();n.request({url:"mynetworkapi/getMyNetworkList",data:{userId:e,baseDate:t,numberOfItemsInCurrentCollection:r,numberOfItemsToLoad:o,lastSeenAck:s},onSuccess:function(e,t){var r=(new Date).getTime(),t=(y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkList:serializeAndCall"}),(new Date).getTime());y.statsclient.getManager(n).send({count:r-t,name:"getMyNetworkList:deserialize"}),i(e.hasMore,e.newActivitiesCount,e.seenAckDate,e.list)},onError:a,requestType:"GET",startTime:u})}function a(e,t,r,n,o,s){var i=(new Date).getTime();e.request({url:"mynetworkapi/getMyPickForNovelties",data:{fromUserId:t,numberOfItemsInCurrentCollection:r,numberOfItemToLoad:n},onSuccess:function(e,t){o(e.hasMore,e.list)},onError:s,requestType:"GET",startTime:i})}function f(e,t,r,n,o,s,i){var a=(new Date).getTime();e.request({url:"mynetworkapi/getMyPickForNovelties2",data:{fromUserId:t,numberOfItemsInCurrentCollection:r,numberOfItemToLoad:n,keyword:o},onSuccess:function(e,t){s(e.hasMore,e.list)},onError:i,requestType:"GET",startTime:a})}function d(e,t,r,n,o,s){var i=(new Date).getTime();e.request({url:"mynetworkapi/getMyTeamsForNovelties",data:{fromUserId:t,numberOfItemsInCurrentCollection:r,numberOfItemToLoad:n},onSuccess:function(e,t){o(e.hasMore,e.list)},onError:s,requestType:"GET",startTime:i})}function T(e,t,r,n,o,s,i){var a=(new Date).getTime();e.request({url:"mynetworkapi/getMyTeamsForNovelties2",data:{fromUserId:t,numberOfItemsInCurrentCollection:r,numberOfItemToLoad:n,keyword:o},onSuccess:function(e,t){s(e.hasMore,e.list)},onError:i,requestType:"GET",startTime:a})}function g(e,t,r,n,o){var s=(new Date).getTime();e.request({url:"mynetworkapi/getNoveltyOrigin",data:{fromUserId:t,treeId:r},onSuccess:function(e,t){n(e.list)},onError:o,requestType:"GET",startTime:s})}function N(e,t,r,n,o,s){var i=(new Date).getTime();e.request({url:"mynetworkapi/pollMyNetworkRealtimeStatus",data:{userId:t,baseDate:r,userCreationDate:n},onSuccess:function(e,t){o(e.newActivitiesCount,e.toShow)},onError:s,requestType:"GET",startTime:i})}function k(e,t,r,n,o,s,i,a){var u=(new Date).getTime(),t={userId:t,baseDate:r,userCreationDate:n,filterVal:o,userIds:JSON.stringify(s)};e.request({url:"mynetworkapi/pollMyNetworkRealtimeStatus2",data:t,onSuccess:function(e,t){i(e.newActivitiesCount,e.toShow)},onError:a,requestType:"GET",startTime:u})}function M(e,t,r,n,o,s,i,a){var u=(new Date).getTime();e.request({url:"mynetworkapi/pollMyNetworkRealtimeStatusLazy",data:{userId:t,baseDate:r,userCreationDate:n,lastPolling:o,lastNotifId:s},onSuccess:function(e,t){i(e.newActivitiesCount,e.toShow,e.lastTimeFullPolling,e.lastNotif)},onError:a,requestType:"GET",startTime:u})}function I(e,t,r,n,o,s,i,a,u,l){var c=(new Date).getTime(),t={userId:t,baseDate:r,userCreationDate:n,lastPolling:o,lastNotifId:s,filterVal:i,userIds:JSON.stringify(a)};e.request({url:"mynetworkapi/pollMyNetworkRealtimeStatusLazy2",data:t,onSuccess:function(e,t){u(e.newActivitiesCount,e.toShow,e.lastTimeFullPolling,e.lastNotif)},onError:l,requestType:"GET",startTime:c})}function v(e,t,r,n,o,s){var i=(new Date).getTime();e.request({url:"mynetworkapi/setMuteOnNoveltySource",data:{fromUserId:t,targetTreeId:r,mute:n},onSuccess:function(e,t){o(e.isOk)},onError:s,requestType:"POST",startTime:i})}Object.defineProperty(t,"__esModule",{value:!0}),t.MyNetwork=void 0,(t=t.MyNetwork={}).copyAndDeleteNetworkItems=w,t.copyAndDeleteNetworkItemsAsync=function(t,n,o,s,i,a,u,l,c,m){return new Promise((r,e)=>{w(t,n,o,s,i,a,u,l,c,m,(e,t)=>{r({copyCount:e,deleteCount:t})},e)})},t.deleteAllNetworkItems=l,t.deleteAllNetworkItemsAsync=function(r,n,o,s,i,a,u){return new Promise((t,e)=>{l(r,n,o,s,i,a,u,e=>{t({found:e})},e)})},t.deleteMyNetworkItem=i,t.deleteMyNetworkItemAsync=function(r,n,o,s){return new Promise((t,e)=>{i(r,n,o,s,e=>{t({found:e})},e)})},t.getMyNetworkFilterList=c,t.getMyNetworkFilterListAsync=function(t,r,n,s,i,a,u,l){return new Promise((o,e)=>{c(t,r,n,s,i,a,u,l,(e,t,r,n)=>{o({hasMore:e,newActivitiesCount:t,seenAckDate:r,list:n})},e)})},t.getMyNetworkFilterList2=m,t.getMyNetworkFilterList2Async=function(t,r,n,s,i,a,u,l,c){return new Promise((o,e)=>{m(t,r,n,s,i,a,u,l,c,(e,t,r,n)=>{o({hasMore:e,newActivitiesCount:t,seenAckDate:r,list:n})},e)})},t.getMyNetworkItem=s,t.getMyNetworkItemAsync=function(t,n,o){return new Promise((r,e)=>{s(t,n,o,(e,t)=>{r({found:e,item:t})},e)})},t.getMyNetworkList=u,t.getMyNetworkListAsync=function(t,r,n,s,i,a){return new Promise((o,e)=>{u(t,r,n,s,i,a,(e,t,r,n)=>{o({hasMore:e,newActivitiesCount:t,seenAckDate:r,list:n})},e)})},t.getMyPickForNovelties=a,t.getMyPickForNoveltiesAsync=function(t,n,o,s){return new Promise((r,e)=>{a(t,n,o,s,(e,t)=>{r({hasMore:e,list:t})},e)})},t.getMyPickForNovelties2=f,t.getMyPickForNovelties2Async=function(t,n,o,s,i){return new Promise((r,e)=>{f(t,n,o,s,i,(e,t)=>{r({hasMore:e,list:t})},e)})},t.getMyTeamsForNovelties=d,t.getMyTeamsForNoveltiesAsync=function(t,n,o,s){return new Promise((r,e)=>{d(t,n,o,s,(e,t)=>{r({hasMore:e,list:t})},e)})},t.getMyTeamsForNovelties2=T,t.getMyTeamsForNovelties2Async=function(t,n,o,s,i){return new Promise((r,e)=>{T(t,n,o,s,i,(e,t)=>{r({hasMore:e,list:t})},e)})},t.getNoveltyOrigin=g,t.getNoveltyOriginAsync=function(r,n,o){return new Promise((t,e)=>{g(r,n,o,e=>{t({list:e})},e)})},t.pollMyNetworkRealtimeStatus=N,t.pollMyNetworkRealtimeStatusAsync=function(t,n,o,s){return new Promise((r,e)=>{N(t,n,o,s,(e,t)=>{r({newActivitiesCount:e,toShow:t})},e)})},t.pollMyNetworkRealtimeStatus2=k,t.pollMyNetworkRealtimeStatus2Async=function(t,n,o,s,i,a){return new Promise((r,e)=>{k(t,n,o,s,i,a,(e,t)=>{r({newActivitiesCount:e,toShow:t})},e)})},t.pollMyNetworkRealtimeStatusLazy=M,t.pollMyNetworkRealtimeStatusLazyAsync=function(t,r,n,s,i,a){return new Promise((o,e)=>{M(t,r,n,s,i,a,(e,t,r,n)=>{o({newActivitiesCount:e,toShow:t,lastTimeFullPolling:r,lastNotif:n})},e)})},t.pollMyNetworkRealtimeStatusLazy2=I,t.pollMyNetworkRealtimeStatusLazy2Async=function(t,r,n,s,i,a,u,l){return new Promise((o,e)=>{I(t,r,n,s,i,a,u,l,(e,t,r,n)=>{o({newActivitiesCount:e,toShow:t,lastTimeFullPolling:r,lastNotif:n})},e)})},t.setMuteOnNoveltySource=v,t.setMuteOnNoveltySourceAsync=function(r,n,o,s){return new Promise((t,e)=>{v(r,n,o,s,e=>{t({isOk:e})},e)})}});
define('app/core/poll/realtimepolling',["require","exports","./genericpoller","app/gen/service/mynetwork","app/squareworld/mynetwork/mynetworkfilterperister","app/gen/service/find","./realtimepollingfacade"],function(e,i,t,s,n,l,o){Object.defineProperty(i,"__esModule",{value:!0}),i.realtimepolling=void 0;let r=n.mynetworkfilter.FilterPersisterModule;{n=i.realtimepolling={};class a extends t.genericpolling.PollingModule{activate(e){var i=new d(this.sandbox);this.pollEngine=i,this.pollingTimer=new g(this.sandbox,this.pollEngine),super.activate(e),i.pollDiscoverUnseenCount()}}n.MyNetworkRealTimeModule=a;class d extends t.genericpolling.PollingEngine{constructor(){super(...arguments),this.lastNotif=null,this.lastPollingTime=0}pollInternal(){var e=r.networkFilterLocalStoragePrefix+PearltreesEnvParams.userId.toString(),e=r.readStoragedFilter(e),i=e.notifType;s.MyNetwork.pollMyNetworkRealtimeStatusLazy2(this.sandbox,PearltreesEnvParams.userId,0,PearltreesEnvParams.userCreationDate,this.lastPollingTime,this.lastNotif,i,e.userIds,(e,i,t,s)=>{this.isPollingRequestPending=!1,this.lastPollingTime!=t&&(this.lastNotif=s,this.lastPollingTime=t,this.onPollingSuccess({newActivitiesCount:e,toShowBadge:i}))},()=>{this.onPollingFailed()})}onPollingSuccess(e){var i=$("#mynetwork-badge");0!=e.newActivitiesCount&&e.toShowBadge?(99<e.newActivitiesCount&&(e.newActivitiesCount=99),this.sandbox.getEventBus().publish(22,0,e.newActivitiesCount),i.html(e.newActivitiesCount.toString()),i.removeClass("hidden")):i.hasClass("hidden")||(i.addClass("hidden"),i.html(""))}onPollingFailed(){this.isPollingRequestPending=!1}pollDiscoverUnseenCount(){l.find.getUserDiscoverUnseenCount(this.sandbox,e=>{this.onDiscoverUnseenResults(e)},()=>{this.onDiscoverUnseenResults(0)})}onDiscoverUnseenResults(e){var i=$("#discover-badge");0==e?i.hasClass("hidden")||(i.addClass("hidden"),i.html("")):(i.html(e.toString()),i.removeClass("hidden"))}}class g extends t.genericpolling.PollingScheduler{constructor(e,i){super(e,i),this.sandbox=e,this.engine=i,o.realtimepolling.subscribeToScheduleRealtimePolling(e,this,e=>{this.schedulePolling(e)})}start(){super.start(),this.intervalId=setInterval(()=>{this.onTimeout()},this.getPollingTimeOut())}getPollingTimeOut(){return 5e3}}}});
define('app/gen/service/arrivaltree',["require","exports","jquery"],function(e,r){function a(e,r,t,i){var a=(new Date).getTime();e.request({url:"userapi/getArrivalTree",data:{resetArrivalTree:r},onSuccess:function(e,r){t(e.arrivalTreeId)},onError:i,requestType:"GET",startTime:a})}Object.defineProperty(r,"__esModule",{value:!0}),r.arrivaltree=void 0,(r=r.arrivaltree={}).getArrivalTree=a,r.getArrivalTreeAsync=function(t,i){return new Promise((r,e)=>{a(t,i,e=>{r({arrivalTreeId:e})},e)})}});
define('app/core/poll/collectpoller',["require","exports","./genericpoller","app/gen/service/arrivaltree","app/core/navigation/navigationclient","app/core/navigation/description"],function(e,i,n,t,l,s){Object.defineProperty(i,"__esModule",{value:!0}),i.collectpolling=void 0;{i=i.collectpolling={};class o extends n.genericpolling.PollingModule{activate(e){this.pollEngine=this.collectPollingEngine=new a(this.sandbox),this.pollingTimer=new g(this.sandbox,this.collectPollingEngine),super.activate(e),this.justRevealedId=this.sandbox.getEventBus().subscribeTo(33,0,this.onJustRevealed,this)}deactivate(){this.sandbox.getEventBus().stopSubscription(this.justRevealedId),super.deactivate()}onJustRevealed(){this.collectPollingEngine.lastReveal=Date.now()}}i.CollectPollingModule=o;class a extends n.genericpolling.PollingEngine{constructor(){super(...arguments),this.lastReveal=0}pollInternal(){t.arrivaltree.getArrivalTree(this.sandbox,!0,e=>{this.onPollingSuccess(e)},()=>{this.onPollingFailed()})}onPollingSuccess(e){var i;this.isPollingRequestPending=!1,!e||Date&&Date.now()<this.lastReveal+1e4||(i=l.navigation.getManager(this.sandbox),e=s.navigation.makeTreeNavigation(e),i.goTo(e))}onPollingFailed(){this.isPollingRequestPending=!1}}class g extends n.genericpolling.PollingScheduler{constructor(e,i){super(e,i),this.sandbox=e,this.engine=i}start(){super.start(),this.engine.pollInternal()}}}});
define('app/premium/premiumprefetch',["require","exports","app/helper/urlhelper","jquery"],function(e,r,s){var t;Object.defineProperty(r,"__esModule",{value:!0}),r.preloader=void 0,(t||(r.preloader={})).PremiumPrefetch=class{get sandbox(){if(this._sandbox)return this._sandbox;throw new Error("Sandbox is not set")}set sandbox(e){this._sandbox=e}activate(e){this.sandbox.isEmbedMode()||this.sandbox.isMobile()||$("body").append('<iframe style="display: none" src="'+s.urlhelper.getPaymentUrl()+'/prefetch"></iframe>')}deactivate(){}}});
define('app/core/orchestra/steps/step4',["require","exports","app/core/poll/realtimepolling","app/core/poll/collectpoller","app/configuration/configuration","app/premium/premiumprefetch","app/core/stats/speed/speedtracker","app/ui/creator/creatorparams","app/gen/service/space"],function(e,a,o,t,r,n,d,i,l){var s;Object.defineProperty(a,"__esModule",{value:!0}),a.steps=void 0,(s||(a.steps={})).Step4Module=class{get sandbox(){if(this._sandbox)return this._sandbox;throw new Error("Sandbox is not set")}set sandbox(e){this._sandbox=e}activate(e,a){var s;this.moduleManager=e.moduleManager,this.sandbox.isEmbedMode()||this.sandbox.isAnonymousMode()||(this.moduleManager.registerModule(1800,e=>new o.realtimepolling.MyNetworkRealTimeModule(e)),this.moduleManager.startModule(1800),this.moduleManager.registerModule(1900,e=>new t.collectpolling.CollectPollingModule(e)),this.moduleManager.startModule(1900)),this.sandbox.isAnonymousMode()||this.sandbox.isEmbedMode()||(this.moduleManager.startModule(2200),PearltreesEnvParams.isDebug||this.sandbox.getSpaceRightManager().hasSpaces()||(this.moduleManager.registerModule(2900,()=>new n.preloader.PremiumPrefetch),this.moduleManager.startModule(2900)),this.sandbox.getSpaceRightManager().shouldNotifyNewSpace()?((e=new i.creatorparams.CreatorAdminParams(this.sandbox,this.sandbox.getSpaceRightManager().getUserSpacesToNotify()[0].spaceId,null,!0)).isTextbookAssignmentAdmin=this.sandbox.getSpaceRightManager().hasNewTextbook(),this.sandbox.getModuleManager().startModule(500,e)):(e=e=>{var a=!1;e&&e.panel&&0!==e.panel&&(a=!0,e={panel:e},this.sandbox.getModuleManager().startModule(4280,e)),a||this.moduleManager.startModule(3800)},s=()=>{this.sandbox.logger.e("error loading arrival panel")},PearltreesEnvParams.shouldHaveUsedGar?l.space.getArrivalPanel2(this.sandbox,e,s):l.space.getArrivalPanel(this.sandbox,e,s)),this.moduleManager.startModule(1151)),this.sandbox.isAnonymousMode()||this.sandbox.isMobile()||this.sandbox.isEmbedMode()||(this.moduleManager.startModule(4500),this.moduleManager.startModule(4030)),r.configuration.getConfig().isDebugAllowed()&&this.handleDebugKeys(),d.speedtracker.SpeedTracker.getTracker(this.sandbox).trackSpeed("step4")}deactivate(){}handleDebugKeys(){var a,s=[];onkeydown=onkeyup=e=>{e=e||event,s[e.keyCode]="keydown"==e.type,s[17]&&s[16]&&s[18]&&s[79]&&(a=a?(this.sandbox.getModuleManager().stopModule(2e3),null):this.sandbox.getModuleManager().startModule(2e3))}}}});
