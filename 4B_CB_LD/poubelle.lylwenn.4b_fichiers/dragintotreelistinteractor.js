define(["require","exports","./draginteractorbase","app/squareworld/interaction/manipulatednodesmodel","app/core/sync/synchroclient","../../../data/pearldata","app/data/treedata","app/ui/settings/sidebarfacade","app/ui/add/droporpastetoadd/animationtype"],function(e,t,r,s,o,d,i,a,h){var n;Object.defineProperty(t,"__esModule",{value:!0}),t.treeWorld=void 0;{(n||(t.treeWorld={})).DragIntoTreeListModule=class{get sandbox(){if(this._sandbox)return this._sandbox;throw new Error("Sandbox is not set")}set sandbox(e){this._sandbox=e}activate(e,t){this.sandbox&&(this.interactor=new l(this.sandbox))}deactivate(){var e;null!=(e=this.interactor)&&e.end()}};class l extends r.treeWorld.DragInteractorBase{constructor(e){super(e),this.isInTreeListZone=!1,this.debugName="DragIntoTreeListInteractor",this.listenerIds.push(this.sandbox.getEventBus().subscribeTo(13,2,()=>{this.startDragging()},this)),this.listenerIds.push(this.sandbox.getEventBus().subscribeTo(13,19,e=>{e.dragInteractor.collectDragInteractor(this)},this)),this.dropListenerId=this.sandbox.getEventBus().subscribeTo(13,5,e=>{"drop"==e.eventType?this.onDropOnElement(e.node):"over"==e.eventType?this.onOverElement(e.node):"out"==e.eventType&&this.onOutElement(e.node)},this),this.manipulatedNodeModel=s.interaction.ManipulatedNodesModel.get(e)}startDragging(){this.hasJustStarted=!0,this.currentTargetTree=void 0,this.targetTreeHierarchy=void 0,this.isInTreeListZone=!1,this.movingTreesIds=void 0}stopScroll(){this.scrollTreeListInteractor&&this.scrollTreeListInteractor.stopScroll()}scroll(e){this.scrollTreeListInteractor||(this.scrollTreeListInteractor=new c(this.sandbox)),0<e?this.scrollTreeListInteractor.startScroll(1):e<0&&this.scrollTreeListInteractor.startScroll(-1)}onOverElement(e){!this.isInTreeListZone&&this.currentTargetTree||this.currentTargetTree&&this.currentTargetTree.id==e.id||(this.changeCurrentNode(e),this.updateManipulatedNodeModel(),this.setOverTimeout(e))}setOverTimeout(e){clearTimeout(this.overTimer),this.overTimerNode=e,this.overTimer=setTimeout(()=>{this.onOverTimeout(e)},500)}clearOverTimeout(e){e!=this.overTimerNode&&null!=e||this.clearHoverTimer()}clearHoverTimer(){(this.overTimerNode=void 0)!==this.overTimer&&(clearTimeout(this.overTimer),this.overTimer=void 0)}onOverTimeout(e){!this.isInTreeListZone||!e.is_open&&(null==this.movingTreesIds&&(this.movingTreesIds=this.manipulatedNodeModel.getFirstLevelTreeIds()),0<=$.inArray(e.id,this.movingTreesIds))||this.sandbox.getEventBus().publish(13,15,e)}onOutElement(e){var t;null!==e&&null!==this.currentTargetTree&&e.id!==(null==(t=this.currentTargetTree)?void 0:t.id)||(this.currentTargetTree=void 0,this.targetTreeHierarchy=void 0),this.clearOverTimeout(e),this.updateManipulatedNodeModel()}onDropOnElement(e){this.clearOverTimeout(e),this.changeCurrentNode(e)}changeCurrentNode(e){this.currentTargetTree=this.makeTreeFromNode(e),this.targetTreeHierarchy=e,this.updateManipulatedNodeModel()}updateManipulatedNodeModel(){var e;!this.currentTargetTree&&this.hasJustStarted||(this.hasJustStarted=!1,e=this.currentTargetTree,setTimeout(()=>{e===this.currentTargetTree&&e&&this.manipulatedNodeModel.updateTargetTree(e)},200))}makeTreeFromNode(e){var r,t={id:e.id,title:e.name,assoId:e.assoId,asso:{id:e.assoId,rootAssoOfUserId:e.rootAssoOfUserId},visibility:e.visibility,spaceId:e.spaceId,pearlCount:e.pearlCount},t=i.TreeData.getTreeData(t);function s(e){var t;e.parent&&e.parent.assoId&&((t=e.parent.assoId)!=e.assoId&&r.indexOf(t)<0&&r.push(t),s(e.parent))}return t.setParentAssoIds((r=[],s(e),r)),t}end(){this.stopScroll(),0<this.dropListenerId&&(this.sandbox.getEventBus().stopSubscription(this.dropListenerId),this.dropListenerId=0),super.end()}getTransmitTweenDuration(){return.3}isInInteractorZone(e,t){var r,s;return 1!==a.sidebarfacade.getSideBarState(this.sandbox)||2===a.sidebarfacade.getSideBarNavigationTreeMode(this.sandbox)?(this.stopScroll(),10):(r=$("#sidebar #collections"),s=10,this.isInSideBar(e,t,r)?(this.isInTreeListZone=this.isPointInTreeListZone(e,t,r),this.isInTreeListZone&&this.stopScroll(),s=20):this.stopScroll(),s)}getInteractorStyle(){return 1}getTargetTree(){return this.currentTargetTree}getInteractorPriority(){return 1}onDragDelegateMove(e,t,r){}onDropDelegateMove(e,t,r){this.isInTreeListZone?this.stopScroll():this.scroll(this.distanceToTreeList||0)}isInSideBar(e,t,r){var s=r.offset();return!!(s&&e<s.left+r.width())}isPointInTreeListZone(e,t,r){var s=$(".sidebar-collections-title");if(s.offset()){s=s.offset().top;if(s<t){if(this.distanceToTreeList=t-r.offset().top-r.height(),this.distanceToTreeList<0)return!(this.distanceToTreeList=0)}else this.distanceToTreeList=t-s}return!1}onDropDelegateStop(e,t,r){this.clearHoverTimer(),this.stopScroll(),this.sandbox.getEventBus().publish(13,14);var s,i=$("#sidebar #collections "),o=(this.isInTreeListZone=this.isPointInTreeListZone(t,r,i),!1);if(this.isInTreeListZone&&this.currentTargetTree)for(s of e.model.getAllSquaresModel()){var a=s.data;if(a.treeId===this.currentTargetTree.id)o=!0;else if(d.PearlData.isSubTree(a))for(var n=a.contentTree.id,l=this.targetTreeHierarchy;l;){if(l.id==n){o=!0;break}l=l.parent}if(o)break}else o=!0;this.manipulatedNodeModel.isInForbiddenState=o,this.isInTreeListZone=!o}onLegalDropDelegateStop(t,r,s,e,i){let o=this.targetTreeHierarchy,a=this.currentTargetTree;if(o&&a)if("create"==s.type)s.create({animationType:h.AnimationType.SWALLOW,targetTreeId:a.id}),this.onOperationSuccess(o);else{let e=s.underlyingSquare;this.setFixedPosition(t,!0),e.model.setDeletePearl(!0),null!=e&&e.hasDetachedShard&&(e.hasDetachedShard.droppedElsewhere=!0);var n=r.collection,l=(n.requestLayout(),t.model.getAllSquaresModel());this.sandbox.getGraphicalQueue().postInstantAction(()=>{r.clearSectionRemovingPearlFromTree(e,1<l.length),n.movePearlsToSubTreeId(l,a.id,()=>{this.onOperationSuccess(o)}),t.setIsHandled(!1)})}}onOperationSuccess(e){this.sandbox.getEventBus().publish(13,5,{node:e,eventType:"sync"})}onDelegateCopyFromExternalZone(e,t,r,s){var i;this.currentTargetTree&&(this.setFixedPosition(e,!0),i=[],s.isDraggingMultiple()?e.model.getAllSquaresModel().forEach(e=>i.push(e.data)):i.push(e.model.data),o.synchroClient.getAPI(this.sandbox).createPearlCopyInTree(i,this.currentTargetTree.id))}preventBackToLayer(){return this.isInTreeListZone}onIllegalDrop(e,t){this.sandbox.logger.assert(!1,"unexpected")}}class c{constructor(e){this.sandbox=e}startScroll(e){this.isScrolling||(this.isScrolling={force:e,scrollSpeed:0,startScrollingDate:new Date,delayScroll:!0},this.scroll())}stopScroll(){this.isScrolling=void 0}obtainScrollableContainer(){return this.$scrollableContainer&&this.isScrollbarContainerValid||(this.$scrollableContainer=$(".tree-list"),this.isScrollbarContainerValid=0<this.$scrollableContainer.parent().length),this.$scrollableContainer}scroll(){var e,t;this.isScrolling&&(e=this.obtainScrollableContainer(),t=(new Date).getTime()-this.isScrolling.startScrollingDate.getTime(),(!this.isScrolling.delayScroll||500<t)&&(this.isScrolling.force*this.isScrolling.scrollSpeed<=0?this.isScrolling.scrollSpeed=.1*this.isScrolling.force:this.isScrolling.scrollSpeed=this.isScrolling.scrollSpeed+.1*(this.isScrolling.force-this.isScrolling.scrollSpeed),t=500*this.isScrolling.scrollSpeed*16/1e3,t=e.scrollTop()+t,e.scrollTop(t),this.sandbox.getEventBus().publish(13,17)),setTimeout(()=>{this.scroll()},16))}}}});